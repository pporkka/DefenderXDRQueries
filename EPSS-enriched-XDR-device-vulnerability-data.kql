// https://github.com/pporkka/DefenderXDRQueries/
// Enrich Defender XDR data with first.org's EPSS data
// EPSS https://www.first.org/epss/
// API description: https://api.first.org/epss/
// Idea is that list should only include existing vulnerabilities in devices that are likely to be exploited
// First: get EPSS data limited with:
// epss rating greater than 0.40 (more than 40% probability of exploitation)
// published last 100 days (concentrating on new vulns)
// Next get matching devices with any of these vulnerabilities and join data by cveid
// 
let epssdata=externaldata(CveId: string, epss: decimal, percentile: decimal, datestamp: string)
[
@"https://api.first.org/data/v1/epss?epss-gt=0.40&days=100&envelope=false"
]
with(format="multijson", 
ingestionMapping='[{"column":"CveId","Properties":{"Path":"$.cve"}},{"column":"epss","Properties":{"Path":"$.epss"}},{"column":"percentile","Properties":{"Path":"$.percentile"}},{"column":"date","Properties":{"Path":"$.date"}}]');
epssdata | project CveId, epss = (epss*100)
| join kind=inner (
DeviceTvmSoftwareVulnerabilities
) on CveId
| project DeviceName, CveId, epss, VulnerabilitySeverityLevel, SoftwareName
| order by epss desc, CveId

// If "envelope" parameter to epss api call is true or not defined, there will be an "envelope" in the result. Here is the full externaldata and ingestionmapping for the result in that case.
// full "externaldata"
//let epssdata=externaldata(status: string, statuscode: string, version: string, access: string, total: string, offset: string, limit: string, cve: string, epss: string, percentile: string, datestamp: string)
// full "ingestion mapping
//ingestionMapping='[{"column":"status","Properties":{"Path":"$.status"}},{"column":"statuscode","Properties":{"Path":"$.status-code"}},{"column":"version","Properties":{"Path":"$.version"}},{"column":"access","Properties":{"Path":"$.access"}},{"column":"total","Properties":{"Path":"$.total"}},{"column":"offset","Properties":{"Path":"$.offset"}},{"column":"limit","Properties":{"Path":"$.limit"}},{"column":"cve","Properties":{"Path":"$.data[0].cve"}},{"column":"epss","Properties":{"Path":"$.data[0].epss"}},{"column":"percentile","Properties":{"Path":"$.data[0].percentile"}},{"column":"date","Properties":{"Path":"$.data[0].date"}}]');
